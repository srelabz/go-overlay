name: CD Pipeline - Release

permissions:
  contents: write
  actions: read
  id-token: write

on:
  push:
    tags: ['v*']
  workflow_dispatch: {}

jobs:
  release:
    name: CD - Release & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with: 
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}

      - name: 🔧 Setup Go
        uses: actions/setup-go@v5
        with: 
          go-version: '1.24.8'

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with: 
          python-version: '3.12'

      - name: 📦 Install Python dependencies
        run: pip install invoke python-dotenv boto3 minio requests

      - name: 🔍 Debug environment
        run: |
          echo "GITHUB_REF: $GITHUB_REF"
          echo "GITHUB_REF_TYPE: $GITHUB_REF_TYPE"
          echo "GITHUB_REPOSITORY: $GITHUB_REPOSITORY"
          echo "GITHUB_SERVER_URL: $GITHUB_SERVER_URL"
          echo "Last 5 tags:"
          git tag --list | tail -5

      - name: 🏷️ Handle tag/branch logic
        id: version
        run: python .github/scripts/release.py
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
          GIT_SSH_COMMAND: 'ssh -o StrictHostKeyChecking=no'

      - name: 📦 Upload release artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: go-overlay-release
          path: release/
          retention-days: 90

      - name: ✅ Release Summary
        if: success()
        run: |
          echo "### ✅ Release Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f release/go-overlay-linux-amd64 ]; then
            SIZE=$(stat -c%s release/go-overlay-linux-amd64)
            echo "- 📦 Binary Size: $(numfmt --to=iec-i --suffix=B $SIZE)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- 🏷️  Version: ${GITHUB_REF#refs/tags/}" >> $GITHUB_STEP_SUMMARY
