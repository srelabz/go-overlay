# Next.js Standalone Stack

This example demonstrates how to use Next.js in standalone mode with go-overlay:
- **Framework**: Next.js 14+ in standalone mode on port 3000
- **Advantage**: Next.js manages both frontend and API routes
- **SSR/SSG**: Server-Side Rendering and Static Site Generation
- **API Routes**: Backend integrated in the same process

## Project Structure

```
project/
├── Dockerfile
├── services.toml
├── next.config.js
├── package.json
├── pages/
│   ├── index.js
│   └── api/
│       └── hello.js
└── .next/
    ├── standalone/   # Generated by build
    ├── static/
    └── ...
```

## services.toml

```toml
[timeouts]
service_shutdown_timeout = 10
global_shutdown_timeout = 30

[[services]]
name = "nextjs-app"
command = "/usr/bin/node"
args = ["/app/server.js"]
enabled = true
required = true
```

## next.config.js (required for standalone)

```javascript
/** @type {import('next').NextConfig} */
module.exports = {
  output: 'standalone',
  // Other Next.js configurations
}
```

## Example: pages/index.js

```javascript
export default function Home() {
  return (
    <div>
      <h1>Next.js with go-overlay</h1>
      <p>SSR working!</p>
    </div>
  );
}
```

## Example: pages/api/hello.js

```javascript
export default function handler(req, res) {
  res.status(200).json({ 
    message: 'Hello from Next.js API Routes!',
    timestamp: new Date().toISOString()
  });
}
```

## Dockerfile

```dockerfile
FROM ubuntu:22.04

# Install Node.js
RUN apt-get update && \
    apt-get install -y curl gnupg && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Download go-overlay
ADD https://github.com/srelabz/go-overlay/releases/latest/download/go-overlay /usr/local/bin/go-overlay
RUN chmod +x /usr/local/bin/go-overlay

# Copy Next.js standalone build
COPY .next/standalone/ /app/
COPY .next/static/ /app/.next/static/
COPY public/ /app/public/

# Copy config
COPY services.toml /etc/go-overlay/services.toml

WORKDIR /app

ENV NODE_ENV=production
ENV PORT=3000

EXPOSE 3000

ENTRYPOINT ["/usr/local/bin/go-overlay", "daemon"]
```

## Multi-Stage Dockerfile (Recommended)

To build everything in a single Dockerfile:

```dockerfile
# Stage 1: Build
FROM node:20-alpine AS builder
WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

# Stage 2: Runtime
FROM ubuntu:22.04

# Install Node.js
RUN apt-get update && \
    apt-get install -y curl gnupg && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Download go-overlay
ADD https://github.com/srelabz/go-overlay/releases/latest/download/go-overlay /usr/local/bin/go-overlay
RUN chmod +x /usr/local/bin/go-overlay

# Copy Next.js build from builder
COPY --from=builder /app/.next/standalone/ /app/
COPY --from=builder /app/.next/static/ /app/.next/static/
COPY --from=builder /app/public/ /app/public/

# Copy config
COPY services.toml /etc/go-overlay/services.toml

WORKDIR /app

ENV NODE_ENV=production
ENV PORT=3000

EXPOSE 3000

ENTRYPOINT ["/usr/local/bin/go-overlay", "daemon"]
```

## How to Run

### Option 1: Local build + Docker

1. **Build Next.js:**
   ```bash
   npm install
   npm run build
   # This generates .next/standalone/
   ```

2. **Build image:**
   ```bash
   docker build -t nextjs-app .
   ```

3. **Run:**
   ```bash
   docker run -p 3000:3000 nextjs-app
   ```

### Option 2: Multi-stage build

```bash
# Build everything at once
docker build -t nextjs-app -f Dockerfile.multistage .

# Run
docker run -p 3000:3000 nextjs-app
```

## Access

- Application: http://localhost:3000
- API Route: http://localhost:3000/api/hello

## CLI Commands

```bash
# List services
docker exec <container-id> go-overlay list

# View status
docker exec <container-id> go-overlay status

# Restart application
docker exec <container-id> go-overlay restart nextjs-app
```

## Features

- ✅ SSR (Server-Side Rendering)
- ✅ SSG (Static Site Generation)
- ✅ ISR (Incremental Static Regeneration)
- ✅ Integrated API Routes
- ✅ React Server Components
- ✅ Optimized standalone mode
- ✅ Image Optimization
- ✅ Hot reload in development

## Environment Variables

You can pass environment variables at runtime:

```bash
docker run -p 3000:3000 \
  -e DATABASE_URL="postgresql://..." \
  -e NEXT_PUBLIC_API_URL="https://api.example.com" \
  nextjs-app
```

## When to use Next.js with go-overlay?

### ✅ Use Next.js when:
- You need SEO (Server-Side Rendering)
- You want API routes in the same process
- Full-stack applications with React
- You need static + dynamic pages
- You want Vercel integration (but self-hosted)

### ⚠️ Avoid Next.js when:
- You need separate backend scaling
- You prefer microservices architecture
- You want to use different backend languages
- Your team doesn't need SSR

## Comparison with other stacks

| Stack | Advantage | Disadvantage |
|-------|-----------|--------------|
| Next.js | All integrated, SEO | Heavier, less flexible |
| React + Express | Flexible, lightweight | Need to configure SSR manually |
| FastAPI + React | Python backend | No native SSR |
